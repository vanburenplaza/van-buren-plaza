(self.webpackChunkrm_frontend=self.webpackChunkrm_frontend||[]).push([[47],{345:function(e,t,s){"use strict";s.r(t),s.d(t,{MagList:function(){return o}});var i=s(336),r=s.n(i),n=s(346),a=s(312),o=r().Collection.extend({model:n.w,load:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.success||a.Z.noop;this.loaded;var s=this;return e.success=function(){t(s),s.loaded=!0},this.fetch(e)},comparator:function(e){return-new Date(e.get("major_update")).getTime()}})},346:function(e,t,s){"use strict";s.d(t,{w:function(){return d}});var i=s(336),r=s.n(i),n=s(321),a=s(340),o=s(308),u=s(323),c=s(347),d=r().Model.extend({idAttribute:"_id",url:function(){if(this.get("user")&&this.get("uri")){var e=this.get("user");n.Z.isObject(e)&&(e=e.get("uri"));var t=e+"/"+this.get("uri")}else t=this.getId();return"/api/readymag/"+t},PUBLISH_URL:"/api/publish/",UNPUBLISH_URL:"/api/unpublish/",parse:function(e){var t=s(345).MagList,i=s(339).UserModel;return e.user&&(this.user=new i(e.user),delete e.user),e.title||(e.emptyTitle=!0),e.title=e.title||"Project",n.Z.isEmpty(e.recentMags)||(this.recentMags=new t(e.recentMags,{parse:!0})),e},getPageNumId:function(e){if(!this.get("pages"))return"";var t=n.Z.find(this.get("pages"),(function(t){return t.num==e}));return t?t.num_id:""},getPageId:function(e){if(!this.get("pages"))return"";var t=n.Z.find(this.get("pages"),(function(t){return t.num==e}));return t?t._id:""},getPageScreenshot:function(e,t){if(e=a.default.screenshotSize(e),t.cover)return!this.get("cover")&&this.get("pages")?this.getPageScreenshot(e,{_id:this.get("coverPid")}):this.get("cover")?a.default.addFilenameComponent(this.get("cover"),e):["/api/screenshot/renew",this.get("num_id"),this.get("coverPid"),(this.get("is_published")?"ready":"")+"?redirect=true&size="+e].join("/");if(this.get("pages")){var s=n.Z.findWhere(this.get("pages"),t);if(s&&s.unauthorized)return this.get("pass_bg")?this.get("pass_bg"):(0,c.findImagePath)("./viewer/mag-password/bg.jpg");var i=s&&s.screenshot;return!i&&s?["/api/screenshot/renew",this.get("num_id"),s._id,(this.get("is_published")?"ready":"")+"?redirect=true&size="+e].join("/"):i&&!isNaN(Number(a.default.getFilenameComponent(i)))?i:a.default.addFilenameComponent(i,e)}console.error("cannot find page screenshot: ",this,t)},getLink:function(){if(!u.Z.isDesktop)return this.getUnpublishedViewerLink();var e=this.get("is_published")&&this.get("uri")||this.getId();return RM.common.customDomainProfile?"/"+e+"/":o.ZP.readymag_host+"/"+this.user.get("uri")+"/"+e+"/"},getUnpublishedViewerLink:function(){return o.ZP.readymag_auth_host+"/"+this.user.get("uri")+"/"+this.get("num_id")},getMagEditLink:function(){return o.ZP.readymag_auth_host+"/edit/"+this.getId()+"/"},getMagEditContentsLink:function(){return u.Z.isDesktop?this.getMagEditLink()+"contents/":this.getUnpublishedViewerLink()},getMagSettingsLink:function(){return this.getMagEditLink()+"settings/"},getId:function(){return this.get("num_id")},getPagesCount:function(){return this.get("pages_count")||this.get("pages")&&this.get("pages").length},deleteMag:function(e){this.deleteXHR&&this.deleteXHR.abort(),this.deleteXHR=$.ajax({type:"DELETE",url:"/api/mags/archive",data:JSON.stringify({mag_num_ids:[Number(this.getId())],folder_num_ids:[]}),contentType:"application/json; charset=utf-8",success:function(t){"function"==typeof e.success&&e.success(t)},error:function(e){console.log("Error deleting mag: "+e.responseText),this.onError("A problem occurred while deleting your project. Please, contact us: "+o.ZP.SUPPORT_MAIL)},context:this}).always((function(){"function"==typeof e.always&&e.always()}))},_changePublishState:function(e,t){var s=!e||"publish"!==e&&"republish"!==e?this.UNPUBLISH_URL:this.PUBLISH_URL;this.publishXHR&&this.publishXHR.abort(),this.publishXHR=$.ajax({type:"POST",url:s+this.getId(),success:function(s){this.set("is_published",e&&"unpublish"!==e),"publish"===e&&(this.set("published",s.published||(new Date).toISOString()),this.set("updated",s.updated||(new Date).toISOString()),this.set("major_update",s.major_update||(new Date).toISOString())),"republish"===e&&this.set(n.Z.extend(n.Z.omit(s,"user"),{updated:this.get("last_changed")})),this.set("coverPid",s.coverPid||this.get("coverPid")),this.set("cover",s.cover||this.get("cover")),"function"==typeof t.success&&t.success()},error:function(t){console.log("Error changing puplish state: "+t.responseText),this.onError("A problem occurred while "+e+"ing your project. Please, contact us: "+o.ZP.SUPPORT_MAIL)},context:this}).always((function(){"function"==typeof t.always&&t.always()}))},publishMag:function(e){this._changePublishState("publish",e)},unpublishMag:function(e){this._changePublishState("unpublish",e)},republishMag:function(e){this._changePublishState("republish",e)},duplicateMag:function(e){var t;t={type:"POST",url:"/api/mag/"+this.get("num_id")+"/duplicate",context:this},n.Z.extend(t,e),this.duplicateXHR&&this.duplicateXHR.abort(),this.duplicateXHR=$.ajax(t)},hasUnsavedChanges:function(){return this.get("is_published")&&this.get("changed")},onError:function(e){alert(e)}})},339:function(e,t,s){"use strict";s.r(t),s.d(t,{UserModel:function(){return g},UsersCollection:function(){return p},UsersLoader:function(){return f},loadUser:function(){return m}});var i=s(312),r=s(336),n=s.n(r),a=s(321),o=s(308),u=s(340),c=n().Model.extend({idAttribute:"_id",urlRoot:"/api/folders/"}),d=n().Collection.extend({model:c,getByUri:function(e){return this.findWhere({uri:e})}}),h=s(345),l=s(347),g=n().Model.extend({userpic_sizes:[64,96,128,192,256],mergePermissionsList:["can_publish"],idAttribute:"uri",url:"/api/me/",SSLDOMAIN_URL:"/api/user/domain/ssl",initialize:function(e,t){a.Z.bindAll(this)},store:function(e,t){e.name&&!/^\s$/.test(e.name)||(e.name=this.get("name")),e=this.changedAttributes(e),this.set(e),this.validate(e)||i.Z.ajax({type:"PUT",url:this.url,data:e,success:t&&"function"==typeof t.success&&t.success,error:t&&"function"==typeof t.error&&t.error})},deletePic:function(){var e=this;i.Z.ajax({type:"DELETE",url:"/api/me/pic/",success:function(){e.set("pic","")}})},validate:function(e){if(void 0!==e.name&&a.Z.isEmpty(i.Z.trim(e.name)))return"Name yourself"},getUserpic:function(e){var t,s=this.get("pic");return Modernizr.retina&&(e*=2),e=a.Z.find(this.userpic_sizes,(function(t){return t>=e})),s?(0==(s=u.default.addFilenameComponent(s,e)).indexOf("https://")||RM.common.isDownloadedSource||-1==s.indexOf("/api/upload/")&&(s="/api/upload/"+s),s):(t=this.get("name").match(/^[a-z0-9]{1}/i))?(0,l.findImagePath)("./stubs/avatar/"+t[0].toLowerCase()+".gif"):(0,l.findImagePath)("./stubs/avatar/"+e+".gif")},getLink:function(){return RM.common.customDomainProfile?"/":RM.common.isDomainViewer?o.ZP.readymag_host+"/"+this.get("uri"):"/"+this.get("uri")},getWebsiteButified:function(){var e,t={link:"",label:""};return this.get("website")&&((e=u.default.URLParts(this.get("website"))).protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path,t.label=e.hostname),t},getTwitterButified:function(){var e,t={link:"",nick:""};return this.get("twitter")&&((e=u.default.URLParts(this.get("twitter"))).protocol||e.path?(e.protocol=e.protocol||"http://",t.nick=e.path.split("/")[1]):(e.protocol="http://",t.nick=e.hostname,e.path="/"+t.nick,e.hostname="twitter.com"),t.link=e.protocol+e.hostname+e.path),t},getFacebookButified:function(){var e,t={link:"",nick:""};if(this.get("fb")){e=u.default.URLParts(this.get("fb"));try{-1!=e.path.indexOf("profile.php")?t.nick="facebook":"pages"==e.path.split("/")[1]?t.nick=decodeURIComponent(e.path.split("/")[2])||"":e.protocol||e.path?t.nick=e.path.split("/")[1].split("?")[0]||"":(t.nick=e.hostname,e.hostname="facebook.com",e.path="/"+t.nick),e.protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path}catch(e){console.log("Error parsing FB URL: ",e)}}return t},mergePermissions:function(e){var t=a.Z.clone(this.get("permissions"));this.set("permissions",e),a.Z.each(this.mergePermissionsList,(function(e){this.attributes.permissions[e]=this.attributes.permissions[e]&&t[e]}),this)},resendConfirmationEmail:function(){i.Z.get("/api/user/confirm/resend")},isPublisher:function(){return this.get("permissions").can_publish},checkDomain:function(e,t){return i.Z.ajax({type:"POST",url:"/api/checkdomain",data:{type:"user",domain:e},success:a.Z.bind((function(s){this.set({last_checked_domain:e},{silent:!0}),t&&t(s)}),this),error:a.Z.bind((function(){console.error(arguments),t&&t(null)}),this)})},mapDomain:function(e,t){return t=t||{},i.Z.ajax({type:"POST",url:"/api/user/domain/",data:{domain:e,status:"on"},success:a.Z.bind((function(s){this.set({domain:e},{silent:!0}),t.success&&t.success(s)}),this),error:a.Z.bind((function(e){return e&&e.status>=500?t.error(null):t.error&&t.error({badDNSSettings:!0})}),this)})},unmapDomain:function(e){return i.Z.ajax({type:"POST",url:"/api/user/domain/",data:{status:"off"},success:a.Z.bind((function(t){this.unset("domain",{silent:!0}),e&&e(t)}),this),error:a.Z.bind((function(){console.error(arguments),e&&e(null)}),this)})},changeSSL:function(e,t,s){return s=s||{},i.Z.ajax({type:"POST",url:this.SSLDOMAIN_URL,data:{domain:e,status:t?"on":"off"},success:a.Z.bind((function(e){s.success&&s.success(e)}),this),error:a.Z.bind((function(e){return console.log(e),e&&e.status>=500?s.error(null):s.error&&s.error(e.responseJSON)}),this)})},getSSLState:function(e,t){return i.Z.ajax({type:"GET",url:this.SSLDOMAIN_URL,data:{domain:e,type:"user"},success:a.Z.bind((function(e){t.success&&t.success(e)})),error:a.Z.bind((function(e){return e&&e.status>=500?t.error(null):t.error&&t.error(e.responseJSON)}))})},isBetaTester:function(){return!!(this.get("permissions")||{}).can_use_beta_testing}}),p=n().Collection.extend({model:g}),f=function(){this.allUsers=new p,this.userMags={},this.userFolders={},a.Z.bindAll(this)};f.prototype={LOAD_URL:"/api/readymags/user/",loadByUsername:function(e){if(RM.common.customDomainProfile&&this.allUsers.at(0)){var t=this.allUsers.at(0),s=this.userMags[this.allUsers.at(0).get("uri")];return t.folders=this.userFolders[this.allUsers.at(0).get("uri")],e.success&&e.success({user:t,mags:s})}var i=this.allUsers.find((function(t){return t.get("uri").toLowerCase()==e.user_uri.toLowerCase()})),r=a.Z.bind((function(t){var s,i;if(!t.user)return e.success({user:t});this.load(t,e.is_me),s=this.allUsers.get(t.user.uri),i=this.userMags[t.user.uri],s.folders=this.userFolders[t.user.uri],e.success&&e.success({user:s,mags:i})}),this);i&&!e.force?(s=this.userMags[i.get("uri")],i.folders=this.userFolders[i.get("uri")],e.success({user:i,mags:s})):this.request(e.user_uri,{success:r,error:e.error})},load:function(e,t){var s;if(!a.Z.isEmpty(e)){var i=e.user||e,r=e.mags,n=i.folders||[];if(i){s=i.uri,d&&(this.userFolders[s]=new d(n,{parse:!0}),delete i.folders),this.allUsers.remove(s),this.allUsers.add(i),t&&i.contributors&&a.Z.each(i.contributors,(function(e){e.member&&(e.member=new g(e.member))}));var o=a.Z.pick(i,"_id","uri","desc","pic");t&&(o.isMe=t),a.Z.each(r,(function(e){e.user=a.Z.clone(o)})),h.MagList&&(this.userMags[s]=new h.MagList(r,{parse:!0}),t&&!a.Z.isEmpty(r)&&this.userMags[s].each((function(e){e.user.set("isMe",!0)})))}}},loadShared:function(e){a.Z.isEmpty(e)||(this.sharedMags={},a.Z.each(e,(function(e){var t=a.Z.pick(e.user,"_id","uri","desc","pic");a.Z.each(e.mags,(function(e){e.user=a.Z.clone(t)})),this.sharedMags[e.user.uri.toLowerCase()]={user:new g(e.user),mags:new h.MagList(e.mags,{parse:!0})}}),this))},request:function(e,t){RM.common.customDomainProfile&&(this.LOAD_URL="/api/domain/readymags/user/",e=""),t=t||{},this.abortLoading();t.success||i.Z.noop;this.loadingXHR=i.Z.ajax(a.Z.extend(t,{type:"GET",url:this.LOAD_URL+e}))},abortLoading:function(){this.loadingXHR&&this.loadingXHR.abort&&this.loadingXHR.abort()}};var m=function(){window.RM.data.usersLoader=new f;var e=window.ServerData.me;window.RM.data.usersLoader.load(e,!0),e?(e=e.user||e).uri&&(window.RM.data.usersLoader.me=window.RM.data.usersLoader.allUsers.get(e.uri)):window.RM.data.usersLoader.me=!1,window.ServerData.mags&&window.ServerData.mags.user&&window.ServerData.mags.mags&&(!window.RM.data.usersLoader.me||window.RM.data.usersLoader.me.get("uri")!==window.ServerData.mags.user.uri)&&window.RM.data.usersLoader.load(window.ServerData.mags),window.ServerData.shared&&window.RM.data.usersLoader.loadShared(window.ServerData.shared),a.Z.isEmpty(window.ServerData.sharedError)||(window.RM.data.usersLoader.sharedError=window.ServerData.sharedError)}},347:function(e,t,s){"use strict";s.d(t,{folderImagesPath:function(){return i},findImagePath:function(){return r},is2X:function(){return n}});var i=window.chunkURL||"https://d1id5eheivyv24.cloudfront.net/e1ae5665/dist/",r=function(e){return"".concat(i,"img").concat(e.substring(1))},n=window.devicePixelRatio>=2}}]);